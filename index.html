<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GalaxyPengin</title>
<link rel="icon" href="/CirclePFP" type="image/png">
<link rel="stylesheet" href="styles.css" />
</head>
<body>

<div class="text-container">
  <div>Welcome to galaxypengin.com!</div>
  <div class="highlight">ðŸš§Under constructionðŸš§</div>
  <div><i>Check back soon!</i></div>
</div>
<div class="embed-container">
  <div class="currently-listening-to-txt">Currently Listening To:</div>
  <div class="alt-embed-txt" id="altEmbedTxt">Nothing is currently playing.</div>
  <div class="embed-info" id="embedInfo">Loading Embed...</div>
</div>
<div class="song-info" id="songInfo">Loading...</div>

<script>
(() => {
  // Extract token from URL and save to localStorage
  const urlParams = new URLSearchParams(window.location.search);
  const refreshToken = urlParams.get('token');
  if (refreshToken) {
    localStorage.setItem('refresh_token', refreshToken);
    history.replaceState(null, '', window.location.pathname);
  }

  const altEmbedTxt = document.getElementById('altEmbedTxt');
  const embedEl = document.getElementById('embedInfo');
  const songEl = document.getElementById('songInfo');

  let currentTrackId = null;

  async function fetchNowPlaying() {
    const token = localStorage.getItem('refresh_token');
    if (!token) return;

    try {
      const response = await fetch('https://spotify-backend-zaoy.onrender.com/now-playing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh_token: token })
      });
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status} - ${errorText}`);
      }
      const data = await response.json();
      console.log(data);

      if (data?.is_playing && data.item?.name && data.item.artists?.length) {
        const track = data.item.name;
        const artists = data.item.artists.map(a => a.name).join(', ');
        songEl.innerHTML = `ðŸŽµ ${track} ðŸŽµ<br>by ${artists}`;

        if (data.item.id !== currentTrackId) {
          currentTrackId = data.item.id;
          altEmbedTxt.style.visibility = 'visible';
          embedEl.innerHTML = `
            <iframe src="https://open.spotify.com/embed/track/${currentTrackId}?theme=0" 
                    width="600" height="160" frameborder="0"
                    allowtransparency="true" allow="encrypted-media"></iframe>`;
        }
      } else {
        altEmbedTxt.style.visibility = 'visible';
        currentTrackId = null;
        embedEl.innerHTML = '';
        songEl.textContent = '';
      }
    } catch (err) {
      songEl.textContent = 'Error retrieving data.';
      console.error('Fetch error:', err);
    }
  }

  fetchNowPlaying();
  setInterval(fetchNowPlaying, 10000);
})();
</script>
  
</body>
